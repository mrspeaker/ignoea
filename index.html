<!DOCTYPE html>
<html>
<head>
	<title>igonea</title>
	<style>
		body {
			margin: 0;
			padding: 0;
		}
		canvas {
			width: 100%;
			height: 100%;
		}
	</style>
</head>
<body>
	<script src="vendor/three.min.js"></script>
	<script src="vendor/OBJLoader.js"></script>
	<script src="vendor/ColladaLoader.js"></script>
	<script src="vendor/TrackballControls.js"></script>
	<script src="src/main.js"></script>
	<script>
		main.init(update);

		var scene = main.gl.scene,
			camera = main.gl.camera;

		var controls = new THREE.TrackballControls( camera );
		
		var cube = main.gl.makeCube();

		controls.panSpeed = 3.8;
		controls.noRoll = true;
		controls.noRotate = true;
		controls.staticMoving = true;
		
		cube.rotation.y = 0;//0.5;
		cube.position.z = -2
		scene.add(cube);
		
		var posx = 0,
			posz = 0,
			targetPoint = new THREE.Vector3();

		document.addEventListener("dblclick", onMouseDown, false);

		var manager = new THREE.LoadingManager();
		manager.onProgress = function (item, loaded, total) {
			console.log(item, loaded, total);
		};
		manager.onLoad = function () {
			main.run();
		};
		manager.onError = function () {
			console.log("error loading", arguments)
		}

		var texture = new THREE.Texture();
		var imgLoader = new THREE.ImageLoader(manager);
		imgLoader.load("textures/UV_Grid_Sm.jpg", function (image) {
			texture.image = image;
			texture.needsUpdate = true;
		});

		var cloader = new THREE.ColladaLoader(),
			groundMesh = null;
		cloader.options.convertUpAxis = true;
		cloader.load( 'obj/lolz.dae', function ( collada ) {
			var dae = collada.scene;
			dae.traverse( function ( child ) {
				if ( child instanceof THREE.Mesh ) {
					//child.material.map = texture;
					var scale = 52;
					child.scale.set(scale, scale, scale);
					scene.add(child);	
					groundMesh = child;
				}
			} );

		});

		var objLoader = new THREE.JSONLoader(manager),
			animation = null;

		objLoader.load('./obj/model.js', function (geometry, materials) {
			var skinnedMesh = new THREE.SkinnedMesh(geometry, new THREE.MeshFaceMaterial(materials));
			skinnedMesh.position.y = 0;
			skinnedMesh.position.z = -5;

			skinnedMesh.scale.set(1, 1, 1);
			scene.add(skinnedMesh);
			 
			animate(skinnedMesh);
		});
		
		var objLoader = new THREE.OBJLoader(manager),
			person = null;

		objLoader.load("obj/male02.obj", function (object) {
			object.traverse( function (child) {
				if (child instanceof THREE.Mesh) {
					child.material.map = texture;
				}
			});
			object.scale.set(0.01, 0.01, 0.01);
			object.position.y = 0.2;
			object.position.z = -2;
			person = object;
			scene.add(object);
		});

		function update() { 
			controls.update();

			//cube.rotation.x += 0.05; 
			cube.rotation.y += 0.05;
			if (person) {
				//person.rotation.x += 0.01;
				//person.position.x += 0.01;
				//person.position.z += 0.01;

				if (targetPoint) {
					person.translateZ(0.05);
					if (person.position.distanceToSquared(targetPoint) < 1) {
						targetPoint = null;
					}
				}
				getIntercectPoint(person, groundMesh);
			}

			if (animation) animation.update(0.06);
		}

		function animate (skinnedMesh) {
			var materials = skinnedMesh.material.materials;		
			for (var k in materials) {
				materials[k].skinning = true;
			}
			animation = new THREE.Animation(skinnedMesh, skinnedMesh.geometry.animation);
			animation.play();
		}

		var raycaster = new THREE.Raycaster();
		function getIntercectPoint(obj, mesh) {
			if (!mesh) return;

			// Cast downwards
			raycaster.set(obj.position, new THREE.Vector3(0, -1, 0));
			var intersects = raycaster.intersectObject(mesh);
			if (!intersects.length) {
				obj.translateY(0.1);
				return;
			}
			//obj.position.set(0, 1, 0);
			//obj.lookAt(intersects[0].face.normal);
			obj.position.copy(intersects[0].point);
			obj.translateY(0.01); // Move up a tiny bit
			
		}

		function onMouseDown( event ) {

			var mouseX = ( event.clientX / window.innerWidth ) * 2 - 1;
			var mouseY = -( event.clientY / window.innerHeight ) * 2 + 1;

			var vector = new THREE.Vector3( mouseX, mouseY, camera.near );

			// Convert the [-1, 1] screen coordinate into a world coordinate on the near plane
			var projector = new THREE.Projector();
			projector.unprojectVector(vector, camera);

			var raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());

			// See if the ray from the camera into the world hits one of our meshes
			var intersects = raycaster.intersectObject(groundMesh);
			//lastIntersects = intersects;

			// Toggle rotation bool for meshes that we clicked
			if (intersects.length > 0) {
				//person.position.set(0, 1, 0);
				//person.lookAt(intersects[0].face.normal);
				// // person.rotation.y -= Math.PI / 2;
				//person.position.copy(intersects[0].point);
				targetPoint = intersects[0].point;
				person.lookAt(targetPoint);
			}

		}

	</script>
</body>
</html>